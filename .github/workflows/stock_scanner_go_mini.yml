name: ğŸ”„ æè‡´_æ¸©å’Œ

on:
  workflow_dispatch:
  push:
    paths:
      - 'stock_scanner_go_mini.py' 
      - '.github/workflows/stock_scanner_go_mini.yml'
  schedule:
    - cron: '23 7 * * *' 

permissions:
  contents: write

jobs:
  run_scanner:
    timeout-minutes: 60 
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1 

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: âš™ï¸ å®‰è£…ä¾èµ–
        run: |
          pip install akshare pandas pytz numpy

      - name: ğŸš€ è¿è¡Œè‚¡ç¥¨ç­›é€‰è„šæœ¬
        run: |
          python stock_scanner_go_mini.py

      - name: ğŸ’¾ è‡ªåŠ¨åŒæ­¥å¹¶æäº¤ç»“æœ
        run: |
          # 1. é…ç½® Git åŸºç¡€ä¿¡æ¯
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git config --global core.quotepath false
          
          # 2. å…³é”®æ­¥éª¤ï¼šæš‚å­˜ï¼ˆStashï¼‰æ–°ç”Ÿæˆçš„ CSV æ–‡ä»¶
          # è¿™æ ·å·¥ä½œåŒºå°±å˜å¹²å‡€äº†ï¼Œå¯ä»¥å®‰å…¨åœ°è¿›è¡Œ rebase
          git add results/**/*.csv
          git stash
          
          # 3. æ‹‰å–è¿œç¨‹æ›´æ–°å¹¶åˆå¹¶
          git pull origin ${{ github.ref_name }} --rebase
          
          # 4. é‡Šæ”¾æš‚å­˜çš„æ–‡ä»¶
          # pop ä¼šå°†ç»“æœæ–‡ä»¶é‡æ–°æ”¾å› results æ–‡ä»¶å¤¹
          git stash pop || echo "No changes to pop"
          
          # 5. æäº¤å¹¶æ¨é€
          git add results/**/*.csv
          if [ -n "$(git status --porcelain)" ]; then
            echo "å‘ç°æ–°æ•°æ®ï¼Œå‡†å¤‡æäº¤..."
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°æè‡´ç²¾é€‰ç»“æœ: $(date +'%Y-%m-%d %H:%M')"
            git push origin ${{ github.ref_name }}
          else
            echo "æ²¡æœ‰å‘ç°æ ‡çš„å˜åŠ¨ï¼Œè·³è¿‡æœ¬æ¬¡æäº¤ã€‚"
          fi
